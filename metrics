<?php

/**
 * This is terrible. But it is simple and works. So it shall be.
 */

# Environment variables.
$hostname = getenv('MYSTROM_HOSTNAME');
$username = getenv('MYSTROM_HTTP_USERNAME');
$password = getenv('MYSTROM_HTTP_PASSWORD');

$url = 'http://' . $hostname . '/report';

$curl = curl_init();

# Basic HTTP Authentication (if set).
if (!empty($username) && !empty($password)) {
  curl_setopt($curl, CURLOPT_HTTPAUTH, CURLAUTH_BASIC);
  curl_setopt($curl, CURLOPT_USERPWD, "$username:$password");
}

curl_setopt($curl, CURLOPT_URL, $url);
curl_setopt($curl, CURLOPT_RETURNTRANSFER, 1);

# Call the URL with curl.
$result = curl_exec($curl);
if (curl_errno($curl)) {
  $error_message = curl_error($curl);
}
curl_close($curl);

# Handle errors.
if (isset($error_message)) {
  echo 'Error: ' . $error_message;
  return;
}

# Parse MYSTROM Plug's JSON payload and return metrics.
$results = json_decode($result);

?>
# HELP power Current real AC power being drawn, in Watts
# TYPE power gauge
power <?php print $results->power; ?>

# HELP temperature Current being drawn, in Celsius
# TYPE temperature gauge
temperature <?php print $results->temperature; ?>

# HELP The average of energy consumed per second from last call this request
# TYPE average gauge
average <?php print $results->Ws; ?>
